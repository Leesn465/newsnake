name: Deploy Spring Boot to OCI with Docker

on:
  push:
    branches: [ ec2_springboot ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 빌드 속도 향상을 위해 캐시 사용 (선택 사항)
      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean build --no-build-cache -x test

      - name: Copy Files to OCI
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          # JAR뿐만 아니라 Docker 설정 파일들도 함께 전송하여 동기화
          source: "build/libs/sbb-0.0.1-SNAPSHOT.jar,Dockerfile,docker-compose.yml,nginx/default.conf"
          target: "~/app"
          overwrite: true

      - name: Docker Deploy and Health Check
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd ~/app
            
            echo "1. 환경변수 파일(.env) 생성..."
            cat > .env <<EOF
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_HOST=${{ secrets.DB_HOST }}
            MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
            MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
            NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
            KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
            KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}
            REDIS_URL=${{ secrets.REDIS_URL }}
            EOF

            echo "2. 기존 systemd 서비스 중지 (최초 전환용)..."
            sudo systemctl stop springboot || true
            sudo systemctl disable springboot || true

            echo "3. Docker Compose 배포 시작..."
            # --build를 사용하여 새로 전송된 JAR를 이미지에 반영
            docker-compose up -d --build

            echo "4. 컨테이너 상태 확인:"
            docker ps

            echo "5. 최근 로그 확인 (50줄):"
            docker logs --tail 50 springboot


            echo "7. 미사용 이미지 정리 (서버 용량 관리)..."
            docker image prune -f
